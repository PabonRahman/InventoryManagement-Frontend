<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title mb-0">
            <i class="fas fa-cash-register me-2"></i>
            {{ isEditMode ? 'Edit Sale' : 'Record New Sale' }}
          </h3>
        </div>

        <div class="card-body">
          <!-- Error Message -->
          <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ errorMessage }}
            <button type="button" class="btn-close" (click)="clearError()"></button>
          </div>

          <form (ngSubmit)="saveSale()" #saleForm="ngForm">

            <!-- Product Selection -->
            <div class="mb-3">
              <label for="product" class="form-label">Product <span class="text-danger">*</span></label>
              <select
                class="form-select"
                id="product"
                [(ngModel)]="sale.product"
                (ngModelChange)="onProductChange($event)"
                name="product"
                [compareWith]="compareProduct"
                required
                #product="ngModel"
                [class.is-invalid]="product.invalid && (product.dirty || product.touched)">
                <option [ngValue]="null" disabled>Select Product</option>
                <option *ngFor="let product of products" [ngValue]="product">
                  {{ product.name }} - {{ product.price | currency:'USD':'symbol':'1.2-2' }} 
                  (Stock: {{ product.quantity }})
                </option>
              </select>
              <div *ngIf="product.invalid && (product.dirty || product.touched)" class="invalid-feedback">
                Please select a product
              </div>
            </div>

            <!-- Store Selection -->
            <div class="mb-3">
              <label for="store" class="form-label">Store <span class="text-danger">*</span></label>
              <select
                class="form-select"
                id="store"
                [(ngModel)]="sale.store"
                (ngModelChange)="onStoreChange($event)"
                name="store"
                [compareWith]="compareStore"
                required
                #store="ngModel"
                [class.is-invalid]="store.invalid && (store.dirty || store.touched)">
                <option [ngValue]="null" disabled>Select Store</option>
                <option *ngFor="let store of stores" [ngValue]="store">
                  {{ store.name }}
                </option>
              </select>
              <div *ngIf="store.invalid && (store.dirty || store.touched)" class="invalid-feedback">
                Please select a store
              </div>
            </div>

            <!-- Quantity & Price -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                  <input
                    type="number"
                    class="form-control"
                    id="quantity"
                    [(ngModel)]="sale.quantity"
                    name="quantity"
                    min="1"
                    [max]="sale.product?.quantity || 0"
                    required
                    #quantity="ngModel"
                    [class.is-invalid]="quantity.invalid && (quantity.dirty || quantity.touched)">
                  <div *ngIf="sale.product" class="form-text">
                    Available: {{ sale.product.quantity }} units
                  </div>
                  <div *ngIf="quantity.invalid && (quantity.dirty || quantity.touched)" class="invalid-feedback">
                    <div *ngIf="quantity.errors?.['required']">Quantity is required</div>
                    <div *ngIf="quantity.errors?.['min']">Quantity must be at least 1</div>
                    <div *ngIf="quantity.errors?.['max']">Quantity exceeds available stock</div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label for="price" class="form-label">Unit Price <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input
                      type="number"
                      class="form-control"
                      id="price"
                      [(ngModel)]="sale.price"
                      name="price"
                      min="0.01"
                      step="0.01"
                      required
                      #price="ngModel"
                      [class.is-invalid]="price.invalid && (price.dirty || price.touched)">
                  </div>
                  <div *ngIf="sale.product" class="form-text">
                    Product price: {{ sale.product.price | currency:'USD':'symbol':'1.2-2' }}
                  </div>
                  <div *ngIf="price.invalid && (price.dirty || price.touched)" class="invalid-feedback">
                    <div *ngIf="price.errors?.['required']">Price is required</div>
                    <div *ngIf="price.errors?.['min']">Price must be at least $0.01</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Total -->
            <div class="mb-3">
              <div class="card bg-light text-center">
                <div class="card-body">
                  <h6 class="card-title mb-1">Total Amount</h6>
                  <h4 class="text-success mb-0">{{ calculateTotal() | currency:'USD':'symbol':'1.2-2' }}</h4>
                  <small class="text-muted">
                    {{ (sale.quantity || 0) }} Ã— {{ (sale.price || 0) | currency:'USD':'symbol':'1.2-2' }}
                  </small>
                </div>
              </div>
            </div>

            <!-- Sale Date -->
            <div class="mb-3">
              <label for="saleDate" class="form-label">Sale Date <span class="text-danger">*</span></label>
              <input
                type="date"
                class="form-control"
                id="saleDate"
                [(ngModel)]="sale.saleDate"
                name="saleDate"
                required
                #saleDate="ngModel"
                [class.is-invalid]="saleDate.invalid && (saleDate.dirty || saleDate.touched)">
              <div *ngIf="saleDate.invalid && (saleDate.dirty || saleDate.touched)" class="invalid-feedback">
                Please select a sale date
              </div>
            </div>

            <!-- Description -->
            <div class="mb-4">
              <label for="description" class="form-label">Description (Optional)</label>
              <textarea
                class="form-control"
                id="description"
                [(ngModel)]="sale.description"
                name="description"
                rows="3"
                maxlength="500"
                placeholder="Add notes..."></textarea>
              <div class="form-text">{{ sale.description?.length || 0 }}/500 characters</div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-outline-secondary" (click)="cancel()" [disabled]="loading">
                <i class="fas fa-times me-1"></i>Cancel
              </button>
              <button type="submit" class="btn btn-success" [disabled]="loading || saleForm.invalid">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                <i class="fas fa-save me-1" *ngIf="!loading"></i>
                {{ isEditMode ? 'Update' : 'Record' }} Sale
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Info -->
      <div class="mt-3">
        <div class="card bg-light">
          <div class="card-body">
            <h6 class="card-title"><i class="fas fa-info-circle me-2"></i>About Sales</h6>
            <p class="card-text small mb-0">
              Recording sales updates inventory and revenue. Product quantities are automatically adjusted.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>